#!/bin/bash

# Xray Transparent Proxy - Bypass Configuration
# 透明代理排除规则配置

# 这个文件定义了哪些流量不走透明代理

# ============================================
# 方法 1: 按用户排除（推荐）
# ============================================
# 创建一个专门的用户来运行不需要代理的程序
# 例如：创建用户 noproxy
# sudo useradd -r -s /bin/false noproxy

# 排除的用户列表（用户名）
BYPASS_USERS=(
    # "noproxy"
    # "mysql"
    # "nginx"
)

# ============================================
# 方法 2: 按 UID 排除
# ============================================
# 直接指定 UID
BYPASS_UIDS=(
    # 1001
    # 1002
)

# ============================================
# 方法 3: 按目标 IP/网段排除
# ============================================
# 这些目标地址不走代理（除了默认的局域网地址）
BYPASS_IPS=(
    # "1.2.3.4"           # 单个 IP
    # "10.0.0.0/8"        # 网段
    # "192.168.1.100"     # 特定服务器
)

# ============================================
# 方法 4: 按目标端口排除
# ============================================
# 这些目标端口不走代理
BYPASS_PORTS=(
    # 22      # SSH
    # 3306    # MySQL
    # 5432    # PostgreSQL
)

# ============================================
# 方法 5: 按源端口排除
# ============================================
# 从这些源端口发出的连接不走代理
BYPASS_SOURCE_PORTS=(
    # 8080
    # 9000
)

# ============================================
# 方法 6: 按进程名排除（需要 cgroup v2）
# ============================================
# 进程名列表
BYPASS_PROCESSES=(
    # "nginx"
    # "mysqld"
    # "redis-server"
)

# ============================================
# 预定义的排除规则集
# ============================================

# 数据库服务（取消注释以启用）
enable_database_bypass() {
    BYPASS_PORTS+=(3306 5432 6379 27017)  # MySQL, PostgreSQL, Redis, MongoDB
}

# 本地开发服务（取消注释以启用）
enable_dev_bypass() {
    BYPASS_IPS+=(
        "127.0.0.0/8"
        "::1/128"
    )
    BYPASS_PORTS+=(3000 8080 8000 5000 9000)
}

# Web 服务器（取消注释以启用）
enable_webserver_bypass() {
    BYPASS_USERS+=(www-data nginx apache)
    BYPASS_PORTS+=(80 443)
}

# ============================================
# 使用说明
# ============================================
# 1. 编辑上面的数组，添加你要排除的项目
# 2. 或者取消注释预定义规则集
# 3. 保存文件
# 4. 重新启用透明代理：
#    sudo ./xray-proxy-manager.sh tproxy-off
#    sudo ./xray-proxy-manager.sh tproxy-on

# 示例：排除特定应用
# 1. 创建专用用户：
#    sudo useradd -r -s /bin/false noproxy
# 2. 添加到 BYPASS_USERS：
#    BYPASS_USERS=("noproxy")
# 3. 以该用户运行程序：
#    sudo -u noproxy your_application
